name: Main

on:
  schedule:
    - cron: '0 4 * * 1,2,3,4,5'
  push:
    branches:
      - main
      - releases/*
    tags:
      - v*

  pull_request:
    branches:
      - main
      - releases/*

  workflow_dispatch:
    inputs:
      skip-test:
        description: 'Skip test'
        type: choice
        required: true
        default: 'false'
        options:
          - "true"
          - "false"

jobs:
  checklist:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.repository != 'kestra-io/plugin-template'
    steps:
      - name: Verify PR checklist
        uses: actions/github-script@v7
        with:
          script: |
            const org = "kestra-io";
            const username = context.payload.pull_request.user.login;
            
            try {
              await github.rest.orgs.checkMembershipForUser({ org, username });
              core.info(`User ${username} is a member of ${org}, skipping checklist validation.`);
              return;
            } catch (e) {
              core.info(`User ${username} is not in ${org}, checklist validation required.`);
            }

            const body = context.payload.pull_request.body || "";
            const unchecked = body.match(/- \[ \]/g);
            if (unchecked) {
              core.setFailed("Some checklist items are still unchecked. Please complete them.");
            } else {
              core.info("All checklist items are checked.");
            }

  check:
    needs: checklist
    uses: kestra-io/actions/.github/workflows/plugins.yml@main
    with:
      skip-test: ${{ github.event.inputs.skip-test == 'true' }}
    secrets: inherit
